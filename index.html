<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bullet Journal â€” Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„</title>
  <style>
    /* ===== Theme (Material-ish) ===== */
    :root{
      --bg:#f7f8fb; --surface:#ffffff; --surface-2:#fafafa; --text:#0f172a; --sub:#5b6b7e;
      --primary:#7c4dff; /* violet */
      --primary-10:#efe9ff; --primary-20:#e3d6ff; --primary-30:#d5c2ff;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --muted:#e6e9ef; --border:#e5e7eb;
      --radius:16px; --shadow:0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.08)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:3;display:flex;align-items:center;gap:8px;padding:14px 16px;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
    header h1{font-size:16px;margin:0;font-weight:800;color:#1f2937}
    .app{display:grid;grid-template-columns:280px 1fr;height:calc(100dvh - 60px)}
    aside{border-left:1px solid var(--border);background:var(--surface);padding:12px;overflow:auto}
    main{padding:16px;overflow:auto}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}

    /* Buttons */
    .btn{position:relative;isolation:isolate;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);cursor:pointer;box-shadow:0 1px 1px rgba(0,0,0,.02)}
    .btn.primary{border-color:var(--primary-20);background:var(--primary-10);color:#3a2a85}
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform:translateY(1px)}

    /* Icon buttons */
    .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#475569;cursor:pointer}
    .iconbtn:hover{filter:brightness(1.03)}
    .iconbtn:active{transform:translateY(1px)}
    .iconbtn svg{width:20px;height:20px}

    /* Ripple (shared) */
    .ripple{position:absolute;inset:auto;pointer-events:none;border-radius:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.15);animation:ripple .6s ease-out}
    @keyframes ripple{from{width:0;height:0;opacity:.35}to{width:180px;height:180px;opacity:0}}

    input,select,textarea{background:#fff;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px;width:100%;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--primary-30);box-shadow:0 0 0 3px var(--primary-10)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:grid;grid-template-columns:32px 1fr auto;gap:8px;align-items:center;padding:10px;border-radius:12px;border:1px dashed var(--border);background:#fff}
    .item.done{opacity:.6;text-decoration:line-through}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:var(--sub)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chips button{border-radius:999px;padding:6px 10px;border:1px solid var(--border);background:#fff;color:#475569;cursor:pointer}
    .chips button.active{color:#3a2a85;background:var(--primary-10);border-color:var(--primary-20)}
    .section-title{font-weight:800;margin:8px 0 4px 0;color:#3a2a85}
    .muted{color:var(--sub)}
    hr{border:none;border-top:1px solid var(--border);margin:8px 0}
    @media (max-width:900px){.app{grid-template-columns:1fr}aside{order:2;height:auto}}

    /* Collections cover & grid */
    .cover{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:12px;border:1px solid var(--border);background:#f5f6fa}
    .coll-grid{display:grid;gap:12px}
    @media (min-width:901px){.coll-grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:900px){.coll-grid{grid-template-columns:repeat(2,1fr)}}
    .coll-card{display:flex;flex-direction:column;gap:8px;padding:10px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:var(--shadow);cursor:pointer}
    .coll-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tagchip{display:inline-flex;gap:4px;align-items:center;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff}

    /* ===== Habits table (classic) ===== */
    .hab-grid{overflow:auto}
    table.hab{border-collapse:collapse;width:100%;min-width:820px}
    .hab th,.hab td{border:1px solid var(--border);background:#fff;padding:6px;text-align:center}
    .hab thead th{position:sticky;top:0;background:#f3f4f6;z-index:1}
    .cell{width:24px;height:24px;border-radius:6px;border:1px solid var(--border);margin:auto;cursor:pointer;transition:background .15s ease,border-color .15s ease}
    .cell.on{background:var(--h, var(--primary-20));border-color:var(--h, var(--primary-30))}

    /* ===== Finance colored pills ===== */
    .pill.expense{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .pill.income{background:#dcfce7;border-color:#bbf7d0;color:#14532d}
    .pill.invest{background:#fef9c3;border-color:#fde68a;color:#854d0e}
    .pill.net.pos{background:#e0f2fe;border-color:#bae6fd;color:#075985}
    .pill.net.neg{background:#ffe4e6;border-color:#fecdd3;color:#9f1239}

    /* ===== Compact cover picker ===== */
    .cover-thumb{width:96px;aspect-ratio:3/4;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#f5f6fa}
    .file-hidden{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
  <link rel="manifest" id="manifestInline" />
  <meta name="theme-color" content="#f7f8fb" />
  <script>
    const tinyPng='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/axu7sAAAAAASUVORK5CYII=';
    const manifest={name:'Bullet Journal â€” Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„',short_name:'BuJo',start_url:'.',display:'standalone',background_color:'#f7f8fb',theme_color:'#7c4dff',lang:'fa',dir:'rtl',icons:[{src:tinyPng,sizes:'192x192',type:'image/png'},{src:tinyPng,sizes:'512x512',type:'image/png'}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    document.addEventListener('DOMContentLoaded',()=>{document.getElementById('manifestInline').href=URL.createObjectURL(blob)});
  </script>
</head>
<body>
  <header>
    <h1>Ø¨ÙˆÙ„Øª Ú˜ÙˆØ±Ù†Ø§Ù„ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„</h1>
    <span class="pill" id="todayLabel"></span>
    <div style="margin-inline-start:auto" class="row">
      <button class="btn" onclick="exportData()">Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
      <label class="btn" for="importFile">ÙˆØ±ÙˆØ¯ JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </header>
  <div class="app">
    <aside class="stack">
      <div class="card stack">
        <div class="section-title">ØµÙØ­Ø§Øª</div>
        <div class="chips">
          <button id="nav-today" class="active" onclick="navigate('today')">Ø§Ù…Ø±ÙˆØ²</button>
          <button onclick="navigate('month')">Ù…Ø§Ù‡</button>
          <button onclick="navigate('collections')">Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§</button>
          <button onclick="navigate('habits')">Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§</button>
          <button onclick="navigate('finance')">Ù…Ø§Ù„ÛŒ</button>
          <button onclick="navigate('search')">Ø¬Ø³ØªØ¬Ùˆ</button>
        </div>
        <div class="section-title">Ú©Ù„ÛŒØ¯Ù‡Ø§ (Signifiers)</div>
        <div class="stack muted">
          <div><button class="btn" onclick="insertSignifier('â€¢ ')">â€¢ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button></div>
          <div><button class="btn" onclick="insertSignifier('â—»ï¸ ')">â—»ï¸ ØªØ³Ú© â†’ âœ“ / Â» / â¤µï¸</button></div>
          <div><button class="btn" onclick="insertSignifier('â—‹ ')">â—‹ Ø±ÙˆÛŒØ¯Ø§Ø¯</button></div>
          <div class="chips">
            <button onclick="insertSignifier(' !')">! Ù…Ù‡Ù…</button>
            <button onclick="insertSignifier(' ?')">? ØªØ­Ù‚ÛŒÙ‚</button>
            <button onclick="insertSignifier(' #')">#Ø¨Ø±Ú†Ø³Ø¨</button>
          </div>
          <small class="muted">Ø±ÙˆÛŒ Ù‡Ø± Ù…ÙˆØ±Ø¯ Ø¨Ø²Ù† ØªØ§ Ø¨Ù‡ Â«ÙˆØ±ÙˆØ¯ Ø³Ø±ÛŒØ¹Â» Ø§ÙØ²ÙˆØ¯Ù‡ Ø´ÙˆØ¯.</small>
        </div>
      </div>

      <div class="card stack">
        <div class="section-title">Ù…Ø¬Ù…ÙˆØ¹Ù‡Ù” Ø³Ø±ÛŒØ¹</div>
        <div class="row">
          <input id="newCollectionName" placeholder="Ù†Ø§Ù… Ù…Ø¬Ù…ÙˆØ¹Ù‡" />
          <button class="btn primary" onclick="addCollection()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div id="collectionsList" class="list"></div>
      </div>

      <div class="card footer">
        Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ùˆ Ø¯Ø± <b>localStorage</b> Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨/Ø³Ø±ÙˆØ±.
      </div>
    </aside>

    <main>
      <!-- Daily -->
      <section id="view-today" class="stack">
        <div class="row">
          <input type="date" id="datePicker" />
          <input id="quickInput" placeholder="ÙˆØ±ÙˆØ¯ Ø³Ø±ÛŒØ¹ (Ù…Ø«Ù„Ø§Ù‹: â—»ï¸ Ø®Ø±ÛŒØ¯ Ù…ÛŒÙˆÙ‡ ! #Ø®Ø§Ù†Ù‡)" />
          <button class="btn primary" onclick="quickAdd()">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div class="chips">
          <button onclick="bulk('complete')">âœ“ Ù‡Ù…Ù‡</button>
          <button onclick="bulk('migrate')">Â» Ù‡Ù…Ù‡</button>
          <button onclick="bulk('schedule')">â¤µï¸ Ù‡Ù…Ù‡</button>
          <button onclick="clearDone()" class="btn">Ø­Ø°Ù Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
        </div>
        <div id="dailyList" class="list"></div>
      </section>

      <!-- Month -->
      <section id="view-month" class="stack" style="display:none">
        <div class="row"><input type="month" id="monthPicker" /> <span id="monthJLabel" class="pill"></span></div>
        <div id="monthList" class="list"></div>
      </section>

      <!-- Collections -->
      <section id="view-collections" class="stack" style="display:none">
        <div class="card stack">
          <div class="row" style="justify-content:space-between">
            <div class="section-title">Ù‡Ù…Ù‡Ù” Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§</div>
            <div class="row"><input id="collSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ù‡..." style="max-width:240px"></div>
          </div>
          <div id="collectionsGrid" class="coll-grid"></div>
        </div>
        <div id="collectionDetail" class="stack"></div>
      </section>

      <!-- Habits -->
      <section id="view-habits" class="stack" style="display:none">
        <div class="card stack">
          <div class="row">
            <input id="hName" placeholder="Ù†Ø§Ù… Ø¹Ø§Ø¯Øª (Ù…Ø«Ù„Ø§Ù‹: ÙˆØ±Ø²Ø´ØŒ Ù…Ø·Ø§Ù„Ø¹Ù‡)" />
            <input type="color" id="hColor" value="#7c4dff" style="width:56px;padding:0;height:40px" />
            <button class="btn primary" onclick="addHabit()">+ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø§Ø¯Øª</button>
            <input type="month" id="hMonth" /> <span id="hMonthJLabel" class="pill"></span>
          </div>
          <div id="hSummary" class="row"></div>
          <div id="hTable" class="hab-grid"></div>
        </div>
      </section>

      <!-- Finance -->
      <section id="view-finance" class="stack" style="display:none">
        <div class="card stack">
          <div class="row">
            <input type="date" id="fDate" />
            <select id="fKind"><option value="expense">Ù‡Ø²ÛŒÙ†Ù‡</option><option value="income">Ø¯Ø±Ø¢Ù…Ø¯</option><option value="invest">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</option></select>
            <input id="fCategory" placeholder="Ø¯Ø³ØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ø®ÙˆØ±Ø§Ú©ØŒ Ø­Ù‚ÙˆÙ‚ØŒ Ø³Ù‡Ø§Ù…)" />
            <input id="fAmount" type="number" step="0.01" placeholder="Ù…Ø¨Ù„Øº" />
            <input id="fNote" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
            <button class="btn primary" onclick="addTxn()">+ Ø§ÙØ²ÙˆØ¯Ù† ØªØ±Ø§Ú©Ù†Ø´</button>
          </div>
          <div class="row">
            <input type="month" id="fMonth" /> <span id="fMonthJLabel" class="pill"></span>
            <button class="btn" onclick="exportFinanceCSV()">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
          </div>
          <div class="row" id="fSummary"></div>
          <div id="fTableWrap" class="stack"></div>
        </div>
      </section>

      <!-- Search -->
      <section id="view-search" class="stack" style="display:none">
        <input id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡Ù” ØµÙØ­Ø§ØªØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† ÛŒØ§ #Ø¨Ø±Ú†Ø³Ø¨" />
        <div id="searchList" class="list"></div>
      </section>
    </main>
  </div>

<script>
// ===== State =====
const fmtJFull  = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
const fmtJShort = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {year:'numeric', month:'long', day:'numeric'});
const fmtJMonth = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {year:'numeric', month:'long'});
function jFull(iso){ try{ return fmtJFull.format(new Date(iso)); }catch{ return iso } }
function jShort(iso){ try{ return fmtJShort.format(new Date(iso)); }catch{ return iso } }
function jMonth(isoMonth){ try{ return fmtJMonth.format(new Date(isoMonth+'-01')); }catch{ return isoMonth } }

const storeKey='mini_bujo_v4';
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().slice(0,10);
function load(){ let d; try{d=JSON.parse(localStorage.getItem(storeKey))||{days:{},collections:{},finance:[],habits:[]}}catch{d={days:{},collections:{},finance:[],habits:[]}}; d.collections=(d.collections||{}); d.finance=(d.finance||[]); d.habits=(d.habits||[]); return d }
function save(d){ localStorage.setItem(storeKey,JSON.stringify(d)) }
function uid(){ return Math.random().toString(36).slice(2,9) }

// ===== Material-like ripple =====
function attachRipples(){ $$('.btn,.iconbtn').forEach(b=>{ if(b.dataset.rippleBound) return; b.dataset.rippleBound='1'; b.addEventListener('click', (e)=>{ const r=document.createElement('span'); r.className='ripple'; const rect=b.getBoundingClientRect(); r.style.left=(e.clientX-rect.left)+'px'; r.style.top=(e.clientY-rect.top)+'px'; b.appendChild(r); setTimeout(()=>r.remove(),600); }) }) }

// ===== Inline SVG icons =====
function svg(name){
  const base='<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="';
  const end='"/></svg>';
  const paths={ check:'M5 13l4 4L19 7', migrate:'M10 17l5-5-5-5M5 12h10', schedule:'M12 8v5l3 3 M7 4h10 M7 8h10', del:'M3 6h18 M8 6v12m8-12v12M5 6l1-2h12l1 2' };
  return base + (paths[name]||'') + end;
}

// ===== Signifiers helper =====
function insertSignifier(text){ const i=$('#quickInput'); if(!i) return; const pos=i.selectionStart||i.value.length; i.value=i.value.slice(0,pos)+text+i.value.slice(pos); i.focus(); i.setSelectionRange(pos+text.length,pos+text.length); }

// ===== Daily =====
function signifierIcon(t){ return t==='task'?'â—»ï¸': t==='event'?'â—‹':'â€¢' }
function parseQuick(text){ const type=text.startsWith('â—»ï¸')?'task': text.startsWith('â—‹')?'event':'note'; const important=/(^|\s)!($|\s)/.test(text); const research=/(^|\s)\?($|\s)/.test(text); const tags=Array.from(text.matchAll(/#([\p{L}\d_\-]+)/gu)).map(m=>m[1]); const content=text.replace(/^([â—»ï¸â—‹â€¢]\s*)?/,'').replace(/[!?]/g,'').trim(); return {type,content,tags,important,research} }
function addItem(day,item){ const d=load(); d.days[day]=d.days[day]||[]; d.days[day].unshift({id:uid(),...item,done:false,migrated:false,scheduled:false,createdAt:Date.now()}); save(d); renderDaily() }
function quickAdd(){ const dp=document.querySelector('#datePicker'); const day=(dp && dp.value)||todayISO(); const qi=document.querySelector('#quickInput'); if(!qi) return; const txt=qi.value.trim(); if(!txt) return; addItem(day,parseQuick(txt)); qi.value='' }
function itemRow(day,it){ const row=document.createElement('div'); row.className='item'+(it.done?' done':''); row.innerHTML=
  '<div class="muted">'+signifierIcon(it.type)+'</div>'+
  '<div><div>'+it.content+' '+(it.important?'<span class="pill">!</span>':'')+' '+(it.research?'<span class="pill">?</span>':'')+' '+it.tags.map(t=>'<span class="pill">#'+t+'</span>').join('')+'</div></div>'+
  '<div class="row">'+
    '<button class="iconbtn" title="Ø§Ù†Ø¬Ø§Ù…" onclick="toggleDone(\''+day+'\',\''+it.id+'\')">'+svg('check')+'</button>'+
    '<button class="iconbtn" title="Ù…Ù‡Ø§Ø¬Ø±Øª" onclick="migrateItem(\''+day+'\',\''+it.id+'\')">'+svg('migrate')+'</button>'+
    '<button class="iconbtn" title="Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ" onclick="scheduleItem(\''+day+'\',\''+it.id+'\')">'+svg('schedule')+'</button>'+
    '<button class="iconbtn" title="Ø­Ø°Ù" onclick="removeItem(\''+day+'\',\''+it.id+'\')">'+svg('del')+'</button>'+
  '</div>';
  return row;
}
function renderDaily(){ const dp=document.querySelector('#datePicker'); const day=(dp && dp.value)||todayISO(); const d=load(); const list=document.querySelector('#dailyList'); if(!list) return; list.innerHTML=''; (d.days[day]||[]).forEach(it=>list.appendChild(itemRow(day,it))); attachRipples() }
function toggleDone(day,id){ const d=load(); const it=(d.days[day]||[]).find(x=>x.id===id); if(!it) return; it.done=!it.done; save(d); renderDaily() }
function migrateItem(day,id){ const target=prompt('Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ Ú†Ù‡ ØªØ§Ø±ÛŒØ®ÛŒØŸ (YYYY-MM-DD)',todayISO()); if(!target) return; const d=load(); const idx=(d.days[day]||[]).findIndex(x=>x.id===id); if(idx<0) return; const it=d.days[day][idx]; it.migrated=true; save(d); addItem(target,it) }
function scheduleItem(day,id){ const target=prompt('Ø¨Ø±Ø§ÛŒ Ú©ÙÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´ÙˆØ¯ØŸ (YYYY-MM-DD)',todayISO()); if(!target) return; const d=load(); const it=(d.days[day]||[]).find(x=>x.id===id); if(!it) return; it.scheduled=true; save(d) }
function removeItem(day,id){ const d=load(); d.days[day]=(d.days[day]||[]).filter(x=>x.id!==id); save(d); renderDaily() }
function bulk(action){ const dp=document.querySelector('#datePicker'); const day=(dp && dp.value)||todayISO(); const d=load(); (d.days[day]||[]).forEach(it=>{ if(action==='complete') it.done=true; if(action==='migrate') it.migrated=true; if(action==='schedule') it.scheduled=true }); save(d); renderDaily() }
function clearDone(){ const dp=document.querySelector('#datePicker'); const day=(dp && dp.value)||todayISO(); const d=load(); d.days[day]=(d.days[day]||[]).filter(x=>!x.done); save(d); renderDaily() }

// ===== Month =====
function renderMonth(){ const d=load(); const mp=document.querySelector('#monthPicker'); const m=(mp && mp.value)||new Date().toISOString().slice(0,7); const list=document.querySelector('#monthList'); if(!list) return; list.innerHTML=''; Object.keys(d.days).filter(x=>x.startsWith(m)).sort().reverse().forEach(day=>{ const card=document.createElement('div'); card.className='card stack'; const cnt=(d.days[day]||[]).length; const done=(d.days[day]||[]).filter(x=>x.done).length; card.innerHTML='<div class="row" style="justify-content:space-between"><b>'+jShort(day)+'</b><span class="muted">'+done+'/'+cnt+' Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span></div>'; (d.days[day]||[]).slice(0,6).forEach(it=>card.appendChild(itemRow(day,it))); list.appendChild(card) }); attachRipples() }

// ===== Collections =====
function addCollection(){ const name=document.querySelector('#newCollectionName').value.trim(); if(!name){alert('Ù†Ø§Ù… Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');return} const d=load(); const id=uid(); d.collections[id]={id,name,items:[],cover:null,tags:[]}; save(d); document.querySelector('#newCollectionName').value=''; renderCollectionsSidebar(); renderCollectionsGrid(); openCollection(id) }
function renderCollectionsSidebar(){ const d=load(); const list=document.querySelector('#collectionsList'); if(!list) return; list.innerHTML=''; const arr=Object.values(d.collections); if(arr.length===0){ list.innerHTML='<span class="muted">Ù‡Ù†ÙˆØ² Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ Ù†Ø³Ø§Ø®ØªÛŒ</span>'; return } arr.forEach(c=>{ const div=document.createElement('div'); div.className='row'; div.innerHTML='<button class="btn" onclick="openCollection(\''+c.id+'\')">'+c.name+'</button>'; list.appendChild(div) }); attachRipples() }
function renderCollectionsGrid(){ const d=load(); const grid=document.querySelector('#collectionsGrid'); if(!grid) return; const si=document.querySelector('#collSearch'); const q=(si && si.value ? si.value : '').trim(); grid.innerHTML=''; let arr=Object.values(d.collections); if(q) arr=arr.filter(c=>c.name.includes(q)||(c.tags||[]).some(t=>t.includes(q)));
  arr.forEach(c=>{ const card=document.createElement('div'); card.className='coll-card'; card.onclick=function(){openCollection(c.id)}; card.innerHTML=
      '<img class="cover" src="'+(c.cover||'')+'" alt="" onerror="this.style.background=\'#f2f3f7\';this.removeAttribute(\'src\')"/>'+
      '<div class="coll-name">'+c.name+'</div>'+
      '<div class="chips">'+(c.tags||[]).slice(0,3).map(t=>'<span class="tagchip">#'+t+'</span>').join('')+'</div>';
    grid.appendChild(card)
  })
}
function openCollection(id){ window.navigate('collections'); const d=load(); const c=d.collections[id]; if(!c) return; const detail=document.querySelector('#collectionDetail'); if(!detail) return; detail.innerHTML='';
  const card=document.createElement('div'); card.className='card stack';
  const tagsHtml=(c.tags||[]).map(t=>'<span class="tagchip">#'+t+' <button class="btn" style="padding:2px 6px" onclick="removeTag(\''+id+'\',\''+t+'\')">Ã—</button></span>').join(' ');
  const coverHtml='<div class="row" style="flex-wrap:wrap">'+
      '<img class="cover-thumb" src="'+(c.cover||'')+'" alt="cover" onerror="this.style.background=\'#f2f3f7\';this.removeAttribute(\'src\')"/>'+
      '<div class="stack" style="flex:1;min-width:220px">'+
        '<div class="section-title">'+c.name+'</div>'+
        '<div class="row"><input id="cov'+id+'" type="file" accept="image/*" class="file-hidden"/><label class="btn" for="cov'+id+'">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§ÙˆØ±</label><button class="btn" onclick="uploadCover(\''+id+'\')">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button><button class="btn" onclick="clearCover(\''+id+'\')">Ø­Ø°Ù Ú©Ø§ÙˆØ±</button></div>'+
        '<div class="row">'+
          '<input id="tagInput'+id+'" placeholder="Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ú†Ø³Ø¨ (Enter)" onkeydown="if(event.key===\'Enter\'){addTag(\''+id+'\')}" >'+
          '<div id="tagWrap'+id+'" class="row" style="flex-wrap:wrap;gap:6px">'+(tagsHtml||'<span class=muted>Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨</span>')+'</div>'+
        '</div>'+
      '</div>'+
    '</div>';
  const controls='<div class="chips">'+
      '<button class="btn" onclick="quickAddToCollection(\''+id+'\',\'project\')">Ù¾Ø±ÙˆÚ˜Ù‡</button>'+
      '<button class="btn" onclick="quickAddToCollection(\''+id+'\',\'task\')">ØªØ³Ú©</button>'+
      '<button class="btn" onclick="quickAddToCollection(\''+id+'\',\'note\')">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>'+
    '</div>'+
    '<div class="row"><input id="ci'+id+'" placeholder="Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯â€¦"><button class="btn primary" onclick="addToCollection(\''+id+'\')">+ Ø§ÙØ²ÙˆØ¯Ù†</button></div>';
  card.innerHTML=coverHtml+controls;
  (c.items||[]).forEach(it=>{ const row=document.createElement('div'); row.className='item'; const text=(typeof it==='string')?it:it.text; const type=(typeof it==='string')?'note':(it.type||'note'); const tagstr=(typeof it==='string')?'':(it.tags||[]).map(t=>'<span class="pill">#'+t+'</span>').join(' '); row.innerHTML='<div class="muted">'+(type==='task'?'â—»ï¸': type==='project'?'â—†':'â€¢')+'</div><div>'+text+' '+tagstr+'</div><div><button class="btn" onclick="removeFromCollection(\''+id+'\',\''+encodeURIComponent(text)+'\')">ğŸ—‘</button></div>'; card.appendChild(row) });
  detail.appendChild(card); attachRipples()
}
function quickAddToCollection(id,type){ const inp=document.querySelector('#ci'+id); if(!inp) return; if(!inp.value.trim()) inp.value = (type==='task'?'â—»ï¸ ':'') + inp.value; inp.focus() }
function addToCollection(id){ const inp=document.querySelector('#ci'+id); const txt=inp.value.trim(); if(!txt) return; const d=load(); const c=d.collections[id]; const tagInput=document.querySelector('#tagInput'+id); const tags=((tagInput && tagInput.value)||'').split(',').map(s=>s.trim()).filter(Boolean); const isTask=txt.startsWith('â—»ï¸'); const item={text:txt.replace(/^â—»ï¸\s*/,''), type=isTask?'task':'note', tags}; c.items.unshift(item); c.tags=[...new Set([...(c.tags||[]), ...tags])]; save(d); inp.value=''; if(tagInput) tagInput.value=''; openCollection(id) }
function removeFromCollection(id,txtEnc){ const txt=decodeURIComponent(txtEnc); const d=load(); const c=d.collections[id]; c.items=c.items.filter(it=> (typeof it==='string')? it!==txt : it.text!==txt ); save(d); openCollection(id) }
function addTag(id){ const inp=document.querySelector('#tagInput'+id); const val=inp && inp.value ? inp.value.trim() : ''; if(!val) return; const d=load(); const c=d.collections[id]; c.tags=[...new Set([...(c.tags||[]), val])]; save(d); inp.value=''; openCollection(id) }
function removeTag(id,t){ const d=load(); const c=d.collections[id]; c.tags=(c.tags||[]).filter(x=>x!==t); save(d); openCollection(id) }
function uploadCover(id){ const inp=document.getElementById('cov'+id); if(!inp||!inp.files||!inp.files[0]){alert('Ø¹Ú©Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯');return} const reader=new FileReader(); reader.onload=function(e){ const d=load(); d.collections[id].cover=e.target.result; save(d); const img=document.querySelector('#collectionDetail .cover-thumb'); if(img){ img.src=e.target.result; } }; reader.readAsDataURL(inp.files[0]) }
function clearCover(id){ const d=load(); d.collections[id].cover=null; save(d); const img=document.querySelector('#collectionDetail .cover-thumb'); if(img){ img.removeAttribute('src'); img.style.background='#f2f3f7'; } }

// ===== Habits =====
function addHabit(){ const name=document.querySelector('#hName').value.trim(); const color=document.querySelector('#hColor').value; if(!name) {alert('Ù†Ø§Ù… Ø¹Ø§Ø¯Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return} const d=load(); d.habits.unshift({id:uid(),name,color,logs:{}}); save(d); document.querySelector('#hName').value=''; renderHabits() }
function renderHabits(){ const d=load(); const hm=document.querySelector('#hMonth'); const month=(hm && hm.value)||new Date().toISOString().slice(0,7); if(hm) hm.value=month; const parts=month.split('-'); const yy=parseInt(parts[0],10), mm=parseInt(parts[1],10); const daysInMonth=new Date(yy, mm, 0).getDate(); const wrap=document.querySelector('#hTable'); if(!wrap) return; wrap.innerHTML=''; const table=document.createElement('table'); table.className='hab';
  let thead='<thead><tr><th>Ø¹Ø§Ø¯Øª</th>'; for(let i=1;i<=daysInMonth;i++){ thead+='<th>'+i.toLocaleString('fa-IR')+'</th>' } thead+='<th>Ø¯Ø±ØµØ¯</th><th>Ø­Ø°Ù</th></tr></thead>';
  table.innerHTML=thead; const tbody=document.createElement('tbody');
  d.habits.forEach(h=>{ const tr=document.createElement('tr'); tr.style.setProperty('--h', h.color); let done=0; const first=document.createElement('td'); first.innerHTML='<span class="pill" style="border-color:'+h.color+'">'+h.name+'</span>'; tr.appendChild(first);
    for(let i=1;i<=daysInMonth;i++){ const day=month+'-'+String(i).padStart(2,'0'); const on=!!h.logs[day]; if(on) done++; const td=document.createElement('td'); td.innerHTML='<div class="cell '+(on?'on':'')+'" title="'+day+'"></div>'; td.onclick=function(){toggleHabit(h.id,day)}; tr.appendChild(td) }
    const rateTd=document.createElement('td'); const rate=Math.round((done/daysInMonth)*100)||0; rateTd.innerHTML='<span class="pill">'+rate+'%</span>'; tr.appendChild(rateTd);
    const delTd=document.createElement('td'); delTd.innerHTML='<button class="btn" onclick="deleteHabit(\''+h.id+'\')">ğŸ—‘</button>'; tr.appendChild(delTd);
    tbody.appendChild(tr) });
  table.appendChild(tbody); wrap.appendChild(table);
  const totalCells=d.habits.reduce((s,h)=>s+Object.keys(h.logs).filter(k=>k.startsWith(month) && h.logs[k]).length,0);
  const hs=document.querySelector('#hSummary'); if(hs) hs.innerHTML='<span class="pill">Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§: '+d.habits.length+'</span><span class="pill">Ù…ÙˆØ§Ø±Ø¯ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡: '+totalCells+'</span>';
  attachRipples()
}
function toggleHabit(hid,day){ const d=load(); const h=d.habits.find(x=>x.id===hid); if(!h) return; h.logs[day]=!h.logs[day]; save(d); renderHabits() }
function deleteHabit(hid){ const d=load(); d.habits=d.habits.filter(x=>x.id!==hid); save(d); renderHabits() }

// ===== Finance =====
function addTxn(){ const fd=document.querySelector('#fDate'); const date=(fd && fd.value)||todayISO(); const kind=document.querySelector('#fKind').value; const category=(document.querySelector('#fCategory').value.trim())||(kind==='income'?'Ø¯Ø±Ø¢Ù…Ø¯':'Ù…ØªÙØ±Ù‚Ù‡'); const amount=parseFloat(document.querySelector('#fAmount').value); const note=document.querySelector('#fNote').value.trim(); if(!(amount>0)){alert('Ù…Ø¨Ù„Øº Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†');return} const d=load(); d.finance.unshift({id:uid(),date,kind,category,amount,note,createdAt:Date.now()}); save(d); document.querySelector('#fAmount').value=''; document.querySelector('#fNote').value=''; renderFinance() }
function labelKind(k){ return k==='expense'?'Ù‡Ø²ÛŒÙ†Ù‡':k==='income'?'Ø¯Ø±Ø¢Ù…Ø¯':'Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ' }
function renderFinance(){ const d=load(); const fm=document.querySelector('#fMonth'); const month=(fm && fm.value)||new Date().toISOString().slice(0,7); if(fm) fm.value=month; const fd=document.querySelector('#fDate'); if(fd && !fd.value) fd.value=todayISO(); const rows=d.finance.filter(t=>(t.date||'').startsWith(month)); let exp=0,inc=0,inv=0; rows.forEach(t=>{ if(t.kind==='expense') exp+=t.amount; else if(t.kind==='income') inc+=t.amount; else inv+=t.amount }); const net=inc-exp-inv;
  const fs=document.querySelector('#fSummary'); if(fs) fs.innerHTML =
    '<span class="pill expense">Ù‡Ø²ÛŒÙ†Ù‡: '+exp.toLocaleString('fa-IR')+'</span>'+
    '<span class="pill income">Ø¯Ø±Ø¢Ù…Ø¯: '+inc.toLocaleString('fa-IR')+'</span>'+
    '<span class="pill invest">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: '+inv.toLocaleString('fa-IR')+'</span>'+
    '<span class="pill net '+(net>=0?'pos':'neg')+'">Ø®Ø§Ù„Øµ: '+net.toLocaleString('fa-IR')+'</span>';
  const wrap=document.querySelector('#fTableWrap'); if(!wrap) return; wrap.innerHTML=''; const table=document.createElement('table'); table.innerHTML='<thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†ÙˆØ¹</th><th>Ø¯Ø³ØªÙ‡</th><th>Ù…Ø¨Ù„Øº</th><th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody></tbody>'; const tb=table.querySelector('tbody'); rows.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+jShort(t.date)+'</td><td>'+labelKind(t.kind)+'</td><td>'+t.category+'</td><td>'+t.amount.toLocaleString('fa-IR')+'</td><td>'+(t.note||'')+'</td><td><button class="btn" onclick="delTxn(\''+t.id+'\')">ğŸ—‘</button></td>'; tb.appendChild(tr) }); wrap.appendChild(table); attachRipples() }
function delTxn(id){ const d=load(); d.finance=d.finance.filter(t=>t.id!==id); save(d); renderFinance() }
function exportFinanceCSV(){ const d=load(); const fm=document.querySelector('#fMonth'); const month=(fm && fm.value)||new Date().toISOString().slice(0,7); const rows=d.finance.filter(t=>(t.date||'').startsWith(month)); const lines=['date,kind,category,amount,note']; rows.forEach(t=>{ lines.push([t.date,t.kind,'"'+t.category.replace(/"/g,'""')+'"',t.amount,'"'+(t.note||'').replace(/"/g,'""')+'"'].join(',')) }); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='finance-'+month+'.csv'; a.click() }

// ===== Search =====
function searchAll(q){ const d=load(); const res=[]; const reTag=q.startsWith('#')?q.slice(1):null; Object.entries(d.days).forEach(function([day,items]){ (items||[]).forEach(function(it){ const text=(it.content+' '+it.tags.join(' ')); const match=reTag?it.tags.includes(reTag):text.includes(q); if(match) res.push({day,it}) }) }); return res.sort(function(a,b){return b.it.createdAt-a.it.createdAt}) }

// ===== Export/Import =====
function exportData(){ const d=load(); const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bujo.json'; a.click() }
document.getElementById('importFile').addEventListener('change',function(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=function(ev){ try{ save(JSON.parse(ev.target.result)); render(); renderHabits(); renderCollectionsGrid(); }catch(e){ alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª') } }; r.readAsText(f) })

// ===== Navigation =====
function navigate(view){
  $$('.chips button').forEach(function(b){ b.classList.remove('active') });
  if(view==='today') document.getElementById('nav-today').classList.add('active');
  ['today','month','collections','habits','finance','search'].forEach(function(v){
    var sec=document.getElementById('view-'+v);
    if(sec) sec.style.display=(v===view?'flex':'none');
  });
  if(view==='finance') renderFinance();
  if(view==='habits') renderHabits();
  if(view==='collections'){ renderCollectionsGrid(); var cd=document.getElementById('collectionDetail'); if(cd) cd.innerHTML=''; }
  attachRipples();
}

// ===== Expose globals =====
Object.assign(window, {
  navigate, exportData, insertSignifier, quickAdd, bulk, clearDone,
  toggleDone, migrateItem, scheduleItem, removeItem,
  addCollection, renderCollectionsGrid, openCollection,
  addToCollection, removeFromCollection, quickAddToCollection,
  uploadCover, clearCover, addTag, removeTag,
  addHabit, toggleHabit, deleteHabit,
  addTxn, delTxn, exportFinanceCSV
});

// ===== Core render (Ø¨Ø¯ÙˆÙ† optional chaining) =====
function render(){
  var dp = document.querySelector('#datePicker');
  var currentDay = (dp && dp.value) || todayISO();
  var tl = document.querySelector('#todayLabel');
  if (tl) tl.textContent = jFull(currentDay);

  renderDaily();
  renderMonth();
  renderCollectionsSidebar();

  var mp = document.querySelector('#monthPicker');
  if (mp) {
    var mj = document.querySelector('#monthJLabel');
    if (mj) mj.textContent = jMonth(mp.value);
  }

  var hm = document.querySelector('#hMonth');
  if (hm) {
    var hj = document.querySelector('#hMonthJLabel');
    if (hj) hj.textContent = jMonth(hm.value);
  }

  var fm = document.querySelector('#fMonth');
  if (fm) {
    var fj = document.querySelector('#fMonthJLabel');
    if (fj) fj.textContent = jMonth(fm.value);
  }
}
window.render = render;

// ===== Init =====
document.getElementById('datePicker').value=todayISO();
document.getElementById('monthPicker').value=new Date().toISOString().slice(0,7);
document.getElementById('todayLabel').textContent=jFull(todayISO());
document.getElementById('hMonth').value=new Date().toISOString().slice(0,7);
document.getElementById('fDate').value=todayISO();
document.getElementById('fMonth').value=new Date().toISOString().slice(0,7);
document.getElementById('monthJLabel').textContent=jMonth(document.getElementById('monthPicker').value);
document.getElementById('hMonthJLabel').textContent=jMonth(document.getElementById('hMonth').value);
document.getElementById('fMonthJLabel').textContent=jMonth(document.getElementById('fMonth').value);

document.getElementById('datePicker').addEventListener('change', function(){ renderDaily(); render(); });
document.getElementById('monthPicker').addEventListener('change', function(){ renderMonth(); document.getElementById('monthJLabel').textContent=jMonth(document.getElementById('monthPicker').value); });
document.getElementById('hMonth').addEventListener('change', function(){ renderHabits(); document.getElementById('hMonthJLabel').textContent=jMonth(document.getElementById('hMonth').value); });
document.getElementById('fMonth').addEventListener('change', function(){ renderFinance(); document.getElementById('fMonthJLabel').textContent=jMonth(document.getElementById('fMonth').value); });
var _cs=document.getElementById('collSearch'); if(_cs) _cs.addEventListener('input', renderCollectionsGrid);

render(); renderHabits(); renderCollectionsGrid(); attachRipples();

// ===== Self tests (optional via ?selftest) =====
(function(){ if(!location.search.includes('selftest')) return;
  console.log('âœ… self tests start');
  console.assert(typeof window.navigate==='function','window.navigate exists');
  console.assert(typeof svg==='function' && svg('check').includes('<svg'),'svg() exists');
  const backup=load(); const month=new Date().toISOString().slice(0,7); const d=load(); d.habits=[{id:'h1',name:'test',color:'#00aa88',logs:{}}]; save(d); const day=month+'-01'; toggleHabit('h1',day); const after=load(); console.assert(after.habits[0].logs[day]===true,'habit toggled on');
  localStorage.setItem(storeKey, JSON.stringify(backup));
  console.log('âœ… self tests end');
})();
</script>

<script>
/* ===== SW guard (no blob) ===== */
async function setupSW(){
  try{
    if(!('serviceWorker' in navigator)) return false;
    const proto=location.protocol;
    const allowed=(proto==='https:'|| (proto==='http:'&&location.hostname==='localhost')) && window.isSecureContext;
    if(!allowed) return false;
    const swUrl=new URL('sw.js',location.href).toString();
    const res=await fetch(swUrl,{method:'GET',cache:'no-store'});
    if(!res.ok) return false;
    await navigator.serviceWorker.register(swUrl,{scope:'./'});
    return true;
  }catch(e){ return false }
}
setupSW();
</script>

</body>
</html>
