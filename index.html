// Global Handlers
const globalHandlers = {
    // افزودن فلگ برای پیگیری وضعیت ذخیره‌سازی
    isSaving: false,
    
    // ... سایر کدهای قبلی بدون تغییر ...

    // به‌روزرسانی تابع saveTask
    saveTask() {
        if (this.isSaving) return; // اگر در حال ذخیره‌سازی هستیم، از تکرار جلوگیری می‌کنیم
        this.isSaving = true; // تنظیم فلگ به حالت ذخیره‌سازی

        try {
            const text = document.getElementById('taskText').value;
            const date = document.getElementById('taskDate').value;
            const saveBtn = document.getElementById('saveTaskBtn');
            
            if (!text) {
                this.showToast('متن وظیفه را وارد کنید');
                return;
            }
            
            // غیرفعال کردن دکمه ذخیره برای جلوگیری از ارسال چندباره
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            // بررسی تکراری نبودن وظیفه
            const existingTask = this.data.tasks.find(task => 
                task.text === text && task.date === date
            );
            
            if (existingTask) {
                this.showToast('این وظیفه قبلاً اضافه شده است');
                return;
            }
            
            const task = {
                id: Date.now().toString(),
                text,
                date,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            this.data.tasks.push(task);
            this.saveData();
            this.closeModal();
            this.renderToday();
            this.showToast('وظیفه با موفقیت افزوده شد');
            
            // فعال کردن مجدد دکمه ذخیره
            saveBtn.disabled = false;
            saveBtn.textContent = 'ذخیره';
        } finally {
            // بازنشانی فلگ در هر صورت
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع saveNote
    saveNote() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const text = document.getElementById('noteText').value;
            const saveBtn = document.getElementById('saveNoteBtn');
            
            if (!text) {
                this.showToast('متن یادداشت را وارد کنید');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            const today = new Date().toISOString().split('T')[0];
            const existingNote = this.data.notes.find(note => 
                note.text === text && note.date === today
            );
            
            if (existingNote) {
                this.showToast('این یادداشت قبلاً اضافه شده است');
                return;
            }
            
            const note = {
                id: Date.now().toString(),
                text,
                date: today,
                createdAt: new Date().toISOString()
            };
            
            this.data.notes.push(note);
            this.saveData();
            this.closeModal();
            this.renderToday();
            this.showToast('یادداشت با موفقیت افزوده شد');
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'ذخیره';
        } finally {
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع saveEvent
    saveEvent() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const saveBtn = document.getElementById('saveEventBtn');
            
            if (!title || !date || !time) {
                this.showToast('تمام فیلدها را پر کنید');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            const existingEvent = this.data.events.find(event => 
                event.title === title && event.date === date && event.time === time
            );
            
            if (existingEvent) {
                this.showToast('این رویداد قبلاً اضافه شده است');
                return;
            }
            
            const event = {
                id: Date.now().toString(),
                title,
                date,
                time,
                createdAt: new Date().toISOString()
            };
            
            this.data.events.push(event);
            this.saveData();
            this.closeModal();
            this.renderToday();
            this.showToast('رویداد با موفقیت افزوده شد');
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'ذخیره';
        } finally {
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع saveHabit
    saveHabit() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const name = document.getElementById('habitName').value;
            const color = document.getElementById('selectedColor').value;
            const saveBtn = document.getElementById('saveHabitBtn');
            
            if (!name) {
                this.showToast('نام عادت را وارد کنید');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            const existingHabit = this.data.habits.find(habit => habit.name === name);
            if (existingHabit) {
                this.showToast('این عادت قبلاً اضافه شده است');
                return;
            }
            
            const habit = {
                id: Date.now().toString(),
                name,
                color,
                completedDates: [],
                createdAt: new Date().toISOString()
            };
            
            this.data.habits.push(habit);
            this.saveData();
            this.closeModal();
            this.renderHabits();
            this.showToast('عادت با موفقیت افزوده شد');
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'ذخیره';
        } finally {
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع saveTransaction
    saveTransaction() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const type = document.getElementById('transactionType').value;
            const amount = parseInt(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDesc').value;
            const date = document.getElementById('transactionDate').value;
            const tags = window.currentTransactionTags || [];
            const saveBtn = document.getElementById('saveTransactionBtn');
            
            if (!amount || amount <= 0) {
                this.showToast('مبلغ معتبر وارد کنید');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            const transaction = {
                id: Date.now().toString(),
                type,
                amount,
                description: description || type,
                tags,
                date,
                createdAt: new Date().toISOString()
            };
            
            this.data.transactions.push(transaction);
            this.saveData();
            this.closeModal();
            this.renderFinance();
            this.showToast('تراکنش با موفقیت ثبت شد');
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'ذخیره';
        } finally {
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع quickAdd
    quickAdd() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const input = document.getElementById('quickInput');
            const text = input.value.trim();
            const addBtn = document.querySelector('.quick-input .btn-primary');
            
            if (!text) {
                this.showToast('متن را وارد کنید');
                return;
            }
            
            addBtn.disabled = true;
            addBtn.textContent = 'در حال افزودن...';
            
            if (text.startsWith('#')) {
                const noteText = text.substring(1);
                const today = new Date().toISOString().split('T')[0];
                const existingNote = this.data.notes.find(note => 
                    note.text === noteText && note.date === today
                );
                
                if (existingNote) {
                    this.showToast('این یادداشت قبلاً اضافه شده است');
                    return;
                }
                
                const note = {
                    id: Date.now().toString(),
                    text: noteText,
                    date: today,
                    createdAt: new Date().toISOString()
                };
                this.data.notes.push(note);
            } else {
                const today = new Date().toISOString().split('T')[0];
                const existingTask = this.data.tasks.find(task => 
                    task.text === text && task.date === today
                );
                
                if (existingTask) {
                    this.showToast('این وظیفه قبلاً اضافه شده است');
                    return;
                }
                
                const task = {
                    id: Date.now().toString(),
                    text,
                    date: today,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                this.data.tasks.push(task);
            }
            
            this.saveData();
            input.value = '';
            this.renderToday();
            this.showToast('با موفقیت افزوده شد');
            
            addBtn.disabled = false;
            addBtn.textContent = 'افزودن';
        } finally {
            this.isSaving = false;
        }
    },

    // به‌روزرسانی تابع saveCollection
    saveCollection() {
        if (this.isSaving) return;
        this.isSaving = true;

        try {
            const name = document.getElementById('collectionName').value;
            const desc = document.getElementById('collectionDesc').value;
            const coverFile = document.getElementById('collectionCover').files[0];
            const saveBtn = document.getElementById('saveCollectionBtn');
            
            if (!name) {
                this.showToast('نام مجموعه را وارد کنید');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'در حال ذخیره...';
            
            let coverImage = '';
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    coverImage = e.target.result;
                    this.saveCollectionWithCover(name, desc, coverImage);
                };
                reader.readAsDataURL(coverFile);
            } else {
                this.saveCollectionWithCover(name, desc, coverImage);
            }
        } catch (error) {
            this.isSaving = false;
            throw error;
        }
    },

    // به‌روزرسانی تابع saveCollectionWithCover
    saveCollectionWithCover(name, desc, coverImage) {
        try {
            const collection = {
                id: Date.now().toString(),
                name,
                description: desc,
                coverImage,
                items: [],
                createdAt: new Date().toISOString()
            };
            
            this.data.collections.push(collection);
            this.saveData();
            this.closeModal();
            this.renderCollections();
            this.showToast('مجموعه با موفقیت افزوده شد');
            
            const saveBtn = document.getElementById('saveCollectionBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ذخیره';
            }
        } finally {
            this.isSaving = false;
        }
    },

    // ... سایر توابع بدون تغییر ...
};
